<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, updateDoc, deleteDoc, addDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore.js";

    // =======================================================
    // 1. CONFIGURE YOUR MASTER TEMPLATE ID
    // =======================================================
    const EMAILJS_SERVICE_ID = 'service_y9vhc7p';
    const EMAILJS_PUBLIC_KEY = 'b5pFhzZJXcBkOv0aC';
    // Use the ID of the template you updated to have {{email_subject}}
    const APPLICANT_TEMPLATE_ID = 'template_jfzey48'; 

    // =======================================================
    // 2. INITIALIZE PAGE (NO CHANGES NEEDED BELOW)
    // =======================================================
    const firebaseConfig = { apiKey: "AIzaSyDfeMg7BzcR1UvsZtFv4SQQtfJZWSdsGxY", authDomain: "lifewood-420.firebaseapp.com", projectId: "lifewood-420", storageBucket: "lifewood-420.firebasestorage.app", messagingSenderId: "277748825194", appId: "1:277748825194:web:a39e906c4bdf3417e25e13" };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    const applicationsListDiv = document.getElementById('applications-list');
    const positionFilter = document.getElementById('position-filter');
    const positionsListUL = document.getElementById('positions-list');
    const positionMgmtForm = document.getElementById('position-management-form');
    const scheduleForm = document.getElementById('schedule-form');
    const hiredForm = document.getElementById('hired-form'); // Get the new form

    let allApplications = []; 
    let activeTab = 'pending';
    
    window.openModal = (modalId) => document.getElementById(modalId).style.display = 'flex';
    window.closeModal = (modalId) => document.getElementById(modalId).style.display = 'none';

    // NEW: Central function to send all applicant emails
    async function sendApplicantEmail(type, appData, details = {}) {
        const templateParams = {
            applicant_email: appData.email,
            applicant_name: appData.name,
            applicant_position: appData.position,
            email_subject: '',
            email_heading: '',
            email_body: ''
        };

        switch (type) {
            case 'passed':
                templateParams.email_subject = `Interview Invitation for ${appData.position}`;
                templateParams.email_heading = "Interview Confirmation";
                templateParams.email_body = `<p>Congratulations! We would like to invite you for an interview. Please see the details below:</p><div style="background-color:#ffffff;border:1px solid #dcd1b5;border-radius:8px;padding:20px;margin:24px 0;"><p style="margin:8px 0;"><strong>Date:</strong> ${details.interview_date}</p><p style="margin:8px 0;"><strong>Time:</strong> ${details.interview_time}</p><p style="margin:8px 0;"><strong>Location:</strong> Ground Floor i2 Building, Cebu IT Park</p></div><p>We look forward to speaking with you!</p>`;
                break;
            case 'failed':
                templateParams.email_subject = `Update on Your Application for ${appData.position}`;
                templateParams.email_heading = "Update on Your Application";
                templateParams.email_body = `<p>Thank you for your interest in the <strong>${appData.position}</strong> position. After careful consideration, we have decided not to move forward with your application. We wish you the best of luck in your job search.</p>`;
                break;
            case 'hired':
                templateParams.email_subject = `Job Offer for ${appData.position}`;
                templateParams.email_heading = "Congratulations! You're Hired!";
                templateParams.email_body = `<p>Following your successful interview, we are thrilled to offer you the position of <strong>${appData.position}</strong>! Please see the next steps below:</p><p>${details.hired_message.replace(/\n/g, '<br>')}</p>`;
                break;
        }
        return emailjs.send(EMAILJS_SERVICE_ID, APPLICANT_TEMPLATE_ID, templateParams);
    }

    function renderTable() {
        let filteredApps = allApplications.filter(app => {
            const status = app.data.status || 'Pending';
            return activeTab === 'pending' ? (status === 'Pending' || status === 'Scheduled') : (status === 'Hired' || status === 'Failed');
        });

        if (positionFilter.value !== 'all') filteredApps = filteredApps.filter(app => app.data.position === positionFilter.value);
        if (filteredApps.length === 0) { applicationsListDiv.innerHTML = `<p>No applications found for this filter.</p>`; return; }

        let tableHtml = `<table><thead><tr><th>Applicant</th><th>Position</th><th>Links</th><th>Status</th><th>Actions</th></tr></thead><tbody>`;
        filteredApps.forEach(app => {
            const { name, email, position, resumeLink, portfolioLink, status = 'Pending', interviewDate, interviewTime } = app.data;
            const docId = app.id;
            let statusHtml = `<strong class="status status-${status.toLowerCase()}">${status}</strong>`;
            if (status === 'Scheduled' && interviewDate) statusHtml += `<br><small>${new Date(interviewDate+'T00:00:00').toLocaleDateString()} @ ${interviewTime}</small>`;
            
            let actionButtonsHtml = '';
            if (status === 'Pending') {
                actionButtonsHtml = `<button class="btn-pass">Pass & Schedule</button><button class="btn-fail">Fail</button>`;
            } else if (status === 'Scheduled') {
                // UPDATED: Show 'Hired' button
                actionButtonsHtml = `<button class="btn-hired">Mark as Hired</button><button class="btn-fail">Fail</button>`;
            } else {
                actionButtonsHtml = `<button class="btn-delete">Delete</button>`;
            }
            
            tableHtml += `<tr id="row-${docId}"><td data-label="Name">${name||'N/A'}<br><a href="mailto:${email}">${email||'N/A'}</a></td><td data-label="Position">${position||'N/A'}</td><td data-label="Links"><a href="${resumeLink}" target="_blank">Resume</a> ${portfolioLink?`| <a href="${portfolioLink}" target="_blank">Portfolio</a>`:''}</td><td data-label="Status">${statusHtml}</td><td class="action-buttons" data-doc-id="${docId}">${actionButtonsHtml}</td></tr>`;
        });
        applicationsListDiv.innerHTML = tableHtml + '</tbody></table>';
    }

    async function fetchAndRenderAll() {
        try {
            const positionsCollection = collection(db, "positions");
            const appsCollection = collection(db, "applications");
            const [positionsSnapshot, appsSnapshot] = await Promise.all([
                getDocs(query(positionsCollection, orderBy("name"))),
                getDocs(query(appsCollection, orderBy("submittedAt", "desc")))
            ]);
            
            allApplications = appsSnapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
            
            positionsListUL.innerHTML = '';
            positionsSnapshot.forEach(doc => { positionsListUL.innerHTML += `<li class="position-tag"><span>${doc.data().name}</span><button class="delete-position-btn" data-doc-id="${doc.id}">Ã—</button></li>`; });
            
            const currentFilter = positionFilter.value;
            positionFilter.innerHTML = '<option value="all">All Positions</option>';
            positionsSnapshot.forEach(doc => { positionFilter.add(new Option(doc.data().name, doc.data().name)); });
            positionFilter.value = currentFilter;

        } catch (err) {
            console.error("Firebase fetch failed:", err);
            applicationsListDiv.innerHTML = `<p style="color: red;"><strong>Error:</strong> Could not load data. Please disable ad-blockers and refresh.</p>`;
        }
        renderTable();
    }

    // Main event listener for all actions
    applicationsListDiv.addEventListener('click', async (e) => {
        const button = e.target.closest('button');
        if (!button) return;
        const docId = e.target.closest('[data-doc-id]').dataset.docId;
        const appData = allApplications.find(app => app.id === docId)?.data;
        if(!appData) { alert('Error: Could not find applicant data.'); return; }

        if (button.matches('.btn-pass')) {
            document.getElementById('schedule-doc-id').value = docId;
            openModal('schedule-modal');
        } else if (button.matches('.btn-fail')) {
            if (!confirm(`This will mark ${appData.name} as Failed and send a rejection email. Are you sure?`)) return;
            button.textContent = 'Failing...'; button.disabled = true;
            await sendApplicantEmail('failed', appData);
            await updateDoc(doc(db, 'applications', docId), { status: 'Failed' });
            await fetchAndRenderAll();
        } else if (button.matches('.btn-hired')) {
            document.getElementById('hired-doc-id').value = docId;
            openModal('hired-modal');
        } else if (button.matches('.btn-delete')) {
            if (confirm('Are you sure you want to permanently delete this application?')) {
                await deleteDoc(doc(db, 'applications', docId));
                await fetchAndRenderAll();
            }
        }
    });

    scheduleForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = e.target.querySelector('button');
        btn.disabled = true; btn.textContent = 'Sending...';
        const docId = document.getElementById('schedule-doc-id').value;
        const appData = allApplications.find(app => app.id === docId)?.data;
        const interviewDate = document.getElementById('schedule-date').value;
        const interviewTime = document.getElementById('schedule-time').value;

        await sendApplicantEmail('passed', appData, { interview_date: new Date(interviewDate+'T00:00:00').toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'}), interview_time: interviewTime });
        await updateDoc(doc(db, 'applications', docId), { status: 'Scheduled', interviewDate, interviewTime });
        
        closeModal('schedule-modal');
        btn.disabled = false; btn.textContent = 'Send Invitation';
        await fetchAndRenderAll();
    });

    // NEW: Event listener for the Hired form
    hiredForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = e.target.querySelector('button');
        btn.disabled = true; btn.textContent = 'Sending...';
        const docId = document.getElementById('hired-doc-id').value;
        const appData = allApplications.find(app => app.id === docId)?.data;
        const hiredMessage = document.getElementById('hired-message').value;

        await sendApplicantEmail('hired', appData, { hired_message: hiredMessage });
        await updateDoc(doc(db, 'applications', docId), { status: 'Hired' });
        
        closeModal('hired-modal');
        btn.disabled = false; btn.textContent = 'Send Offer';
        await fetchAndRenderAll();
    });

    // Listeners for position management and other controls
    document.getElementById('manage-positions-btn').addEventListener('click', () => openModal('positions-modal'));
    document.querySelectorAll('.tab-btn').forEach(b => b.addEventListener('click', () => {
        document.querySelector('.tab-btn.active').classList.remove('active');
        b.classList.add('active'); activeTab = b.dataset.tab; renderTable();
    }));
    positionFilter.addEventListener('change', renderTable);
    document.getElementById('logout-button').addEventListener('click', () => { sessionStorage.removeItem('lifewood_admin_auth'); window.location.replace('index.html'); });
    
    emailjs.init(EMAILJS_PUBLIC_KEY);
    fetchAndRenderAll();
</script>
</body>
</html>
